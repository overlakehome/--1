#!/usr/bin/env ruby
%w{optparse open-uri JSON}.each { |e| require e }

$options = {}
OptionParser.new do |opts|
  opts.on('-s', '--headlines INTEGER', Integer, 'Skips processing the specified # of headlines (default: 1).') { |v| $options[:headlines] = v }
  opts.on('-m', '--max-lines INTEGER', Integer, 'Processes as many as the specified # of lines.') { |v| $options[:max_lines] = v }
  opts.on('-c', '--cut-off FLOAT', Float, 'Cuts off numbers smaller than the specified # (default: -0.1).') { |v| $options[:cut_off] = v }
end.parse!
headlines = $options[:headlines] || 0
max_lines = $options[:max_lines]
cut_off = $options[:cut_off] || 0.1;

open(ARGV[0]).each do |l|
  next if 0 <= headlines -= 1
  break if max_lines && 0 > max_lines -= 1
  t, l = l.chomp.split(%Q(\t))
  h = JSON[l.gsub(%r(([^,{]+)\s*:), %q("\1":))].
    reduce({}) { |h, (k,v)| h[k] = v.round(3) if v > cut_off; h }
  j [t, h]
end
